<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CRC</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui;background:#2d2d2d;color:#fff;height:100vh;overflow:hidden}
.header{background:#1e1e1e;border-bottom:1px solid #444;display:flex;height:40px}
.tab{padding:0 20px;display:flex;align-items:center;cursor:pointer;color:#888;border-right:1px solid #444;font-size:13px}
.tab:hover{background:#333;color:#fff}
.tab.active{background:#0e639c;color:#fff}
.status{margin-left:auto;padding:0 15px;display:flex;align-items:center;gap:6px;font-size:11px}
.dot{width:8px;height:8px;border-radius:50%;background:#888}
.dot.ok{background:#4ade80}
.content{height:calc(100vh - 40px)}
.page{display:none;height:100%}
.page.active{display:block}
webview{width:100%;height:100%}
.panel{padding:20px;height:100%;overflow-y:auto}
.box{background:#1e1e1e;border:1px solid #444;border-radius:4px;padding:15px;margin-bottom:15px}
.box h3{font-size:14px;margin-bottom:15px}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.stat{background:#2d2d2d;padding:15px;text-align:center;border-radius:4px}
.stat-num{font-size:28px;font-weight:bold;color:#4ade80}
.stat-label{font-size:11px;color:#888;margin-top:5px}
button{background:#0e639c;color:#fff;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;font-size:13px;margin-right:8px}
button:hover{background:#1177bb}
button.red{background:#c32e2e}
button.red:hover{background:#9a2222}
.logs{background:#0d0f13;padding:10px;border-radius:4px;font-family:Consolas,monospace;font-size:11px;height:300px;overflow-y:auto;color:#888}
.config-row{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #444}
.config-row:last-child{border:none}
.switch{position:relative;width:44px;height:24px}
.switch input{display:none}
.switch span{position:absolute;cursor:pointer;background-color:#555;border-radius:24px;top:0;right:0;bottom:0;left:0;transition:.2s}
.switch span:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;border-radius:50%;transition:.2s}
input:checked+span{background-color:#0e639c}
input:checked+span:before{transform:translateX(20px)}
</style>
</head>
<body>
<div class="header">
<div class="tab active" data-page="crc">🌐 CRC</div>
<div class="tab" data-page="admin">📊 Admin</div>
<div class="tab" data-page="config">⚙️ Config</div>
<div class="status"><span class="dot" id="dot"></span><span id="txt">Backend</span></div>
</div>
<div class="content">
<div class="page active" id="crc">
<webview 
    id="crcWebview" 
    src="https://sistema.registrocivil.org.br/indexFrame.cfm" 
    preload="./preload-webview.js"
    partition="persist:crc" 
    allowpopups 
    nodeintegration 
    webpreferences="contextIsolation=false"
></webview>
</div>
<div class="page" id="admin">
<div class="panel">
<div class="box">
<h3>📊 Estatísticas</h3>
<div class="stats">
<div class="stat"><div class="stat-num" id="total">-</div><div class="stat-label">Total</div></div>
<div class="stat"><div class="stat-num" id="pend" style="color:#fbbf24">-</div><div class="stat-label">Pendentes</div></div>
<div class="stat"><div class="stat-num" id="emit">-</div><div class="stat-label">Emitidos</div></div>
<div class="stat"><div class="stat-num" id="selos">-</div><div class="stat-label">Selos</div></div>
</div>
<div style="margin-top:15px">
<button onclick="loadStats()">🔄 Atualizar</button>
<button onclick="openBackend()">🌐 Backend</button>
</div>
</div>
<div class="box">
<h3>🎮 Controles</h3>
<button onclick="restart()">🔁 Reiniciar</button>
<button class="red" onclick="stop()">⏹️ Parar</button>
</div>
<div class="box">
<h3>📝 Logs</h3>
<div class="logs" id="logs">[INFO] Aguardando...</div>
</div>
</div>
</div>
<div class="page" id="config">
<div class="panel">
<div class="box">
<h3>⚙️ Automações</h3>
<div class="config-row"><span>Backend API (porta 3100)</span><label class="switch"><input type="checkbox" id="t1" checked><span></span></label></div>
<div class="config-row"><span>Playwright Automation</span><label class="switch"><input type="checkbox" id="t2"><span></span></label></div>
<div class="config-row"><span>Sync de Selos</span><label class="switch"><input type="checkbox" id="t3" checked><span></span></label></div>
</div>
<div class="box">
<h3>🔗 URLs</h3>
<div class="config-row"><span>Backend</span><span style="color:#4ade80">localhost:3100</span></div>
<div class="config-row"><span>CRC</span><span style="color:#4ade80">registrocivil.org.br</span></div>
</div>
<div class="box">
<button onclick="saveConfig()">💾 Salvar</button>
<button class="red" onclick="resetConfig()">🔄 Resetar</button>
</div>
</div>
</div>
</div>
<script>
const {ipcRenderer,shell}=require('electron');
const fs = require('fs');
const path = require('path');

// WEBVIEW - Injetar Explorer Selos completo
const webview = document.getElementById('crcWebview');

webview.addEventListener('dom-ready', () => {
    console.log('[WEBVIEW] DOM Ready - tentando injetar script...');
    
    // Carregar o script completo do Explorer Selos
    const scriptPath = path.join(__dirname, 'explorer-selos.js');
    fs.readFile(scriptPath, 'utf8', (err, code) => {
        if (err) {
            console.error('Erro ao carregar explorer-selos.js:', err);
            log('[ERRO] Falha ao carregar Explorer Selos');
            return;
        }
        
        console.log('[WEBVIEW] Script carregado, injetando...');
        
        // Injetar o script completo no webview
        webview.executeJavaScript(code)
            .then(() => {
                console.log('[WEBVIEW] Explorer Selos injetado com sucesso!');
                log('[OK] Explorer Selos ativo! (Shift+S)');
            })
            .catch(e => {
                console.error('Erro ao injetar script:', e);
                log('[ERRO] Falha ao injetar script');
            });
    });
    
    // Também injeta atalhos básicos
    webview.executeJavaScript(`
        console.log('[CRC] UserScripts carregados no webview');
        
        // Ctrl+Q para Imprimir
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 'q') {
                e.preventDefault();
                const btn = document.querySelector('input[type="button"][value="Imprimir"].botao');
                if (btn) {
                    btn.click();
                    console.log('[CRC] Ctrl+Q acionado');
                }
            }
        });
    `);
});

document.querySelectorAll('.tab').forEach(t=>{t.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.getElementById(t.dataset.page).classList.add('active')}});
async function checkBackend(){try{await fetch('http://localhost:3100/health');document.getElementById('dot').classList.add('ok');document.getElementById('txt').textContent='Online'}catch{document.getElementById('dot').classList.remove('ok');document.getElementById('txt').textContent='Offline'}}
async function loadStats(){try{const r=await fetch('http://localhost:3100/estatisticas');const d=await r.json();if(d.sucesso){document.getElementById('total').textContent=d.dados.total_registros||0;document.getElementById('pend').textContent=d.dados.pendentes||0;document.getElementById('emit').textContent=d.dados.emitido||0;document.getElementById('selos').textContent=d.dados.selos_disponiveis||0;log('[OK] Stats atualizadas')}}catch{log('[ERRO] Falha stats')}}
async function restart(){log('[INFO] Reiniciando...');const r=await ipcRenderer.invoke('reiniciar-backend');if(r.success){log('[OK] Reiniciado!');setTimeout(checkBackend,3000)}}
async function stop(){if(!confirm('Parar backend?'))return;log('[INFO] Parando...');const r=await ipcRenderer.invoke('parar-backend');if(r.success)log('[OK] Parado!')}
function openBackend(){shell.openExternal('http://localhost:3100')}
function saveConfig(){const c={backend:document.getElementById('t1').checked,playwright:document.getElementById('t2').checked,selos:document.getElementById('t3').checked};localStorage.setItem('cfg',JSON.stringify(c));log('[OK] Config salva!')}
function loadConfig(){const c=localStorage.getItem('cfg');if(c){const o=JSON.parse(c);document.getElementById('t1').checked=o.backend??true;document.getElementById('t2').checked=o.playwright??false;document.getElementById('t3').checked=o.selos??true}}
function resetConfig(){if(!confirm('Resetar?'))return;localStorage.removeItem('cfg');document.getElementById('t1').checked=true;document.getElementById('t2').checked=false;document.getElementById('t3').checked=true;log('[OK] Resetado')}
function log(msg){const l=document.getElementById('logs');const t=new Date().toLocaleTimeString();l.innerHTML+='\n['+t+'] '+msg;l.scrollTop=l.scrollHeight}
loadConfig();checkBackend();setInterval(checkBackend,30000);setTimeout(loadStats,2000);setInterval(loadStats,60000);
</script>
</body>
</html>
